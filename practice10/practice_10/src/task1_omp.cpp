/**
 * ЗАДАНИЕ 1. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ CPU-ПАРАЛЛЕЛЬНОЙ ПРОГРАММЫ (OPENMP)
 */

// Подключение стандартной библиотеки ввода-вывода
#include <iostream>
// Подключение контейнера вектор для хранения данных
#include <vector>
// Подключение библиотеки интерфейса OpenMP
#include <omp.h>
// Подключение математических функций
#include <cmath>
// Подключение манипуляторов вывода для форматирования чисел
#include <iomanip>
// Подключение системного заголовка Windows для настройки кодировки консоли
#include <windows.h>

int main() {
    // Установка кодовой страницы UTF-8 для корректного вывода кириллицы
    SetConsoleOutputCP(65001);
    // Установка кодовой страницы UTF-8 для ввода данных через консоль
    SetConsoleCP(65001);

    // Определение константы размера массива (100 миллионов элементов)
    const size_t N = 100000000;
    // Выделение динамической памяти и инициализация массива единицами
    std::vector<double> data(N, 1.0);

    // Цикл для перебора различного количества вычислительных потоков
    for (int threads : {1, 2, 4, 8}) {
        // Установка лимита активных потоков для параллельных областей
        omp_set_num_threads(threads);

        // Фиксация астрономического времени начала выполнения алгоритма
        double t_start = omp_get_wtime();

        // Инициализация переменной для накопления глобальной суммы
        double total_sum = 0.0;

        // Объявление параллельной области для распределения итераций цикла
        #pragma omp parallel for reduction(+:total_sum)
        // Итерационный проход по всему объему данных массива
        for (int i = 0; i < (int)N; i++) {
            // Агрегирование значений элементов в переменную с защитой от гонки данных
            total_sum += data[i];
        }

        // Последовательная операция: вычисление среднего арифметического значения
        double mean = total_sum / N;
        // Инициализация переменной для суммирования квадратов отклонений
        double variance_sum = 0.0;

        // Объявление второй параллельной области для расчета дисперсии
        #pragma omp parallel for reduction(+:variance_sum)
        // Параллельный проход по массиву для вычисления отклонений
        for (int i = 0; i < (int)N; i++) {
            // Расчет разности между текущим элементом и средним значением
            double diff = data[i] - mean;
            // Суммирование квадратов разностей с использованием редукции
            variance_sum += diff * diff;
        }

        // Регистрация времени завершения всех вычислительных операций
        double t_end = omp_get_wtime();

        // Определение итоговой длительности выполнения задачи
        double duration = t_end - t_start;

        // Вывод статистических данных в консоль в форматированном виде
        std::cout << "Количество активных потоков: " << threads
                  << " | Общее время выполнения: " << std::fixed << std::setprecision(5)
                  << duration << " сек." << std::endl;
    }

    // Завершение выполнения функции с возвратом нулевого кода ошибки
    return 0;
}